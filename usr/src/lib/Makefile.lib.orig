#
# CDDL HEADER START
#
# The contents of this file are subject to the terms of the
# Common Development and Distribution License (the "License").
# You may not use this file except in compliance with the License.
#
# You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
# or http://www.opensolaris.org/os/licensing.
# See the License for the specific language governing permissions
# and limitations under the License.
#
# When distributing Covered Code, include this CDDL HEADER in each
# file and include the License file at usr/src/OPENSOLARIS.LICENSE.
# If applicable, add the following below this CDDL HEADER, with the
# fields enclosed by brackets "[]" replaced with your own identifying
# information: Portions Copyright [yyyy] [name of copyright owner]
#
# CDDL HEADER END
#
#
# Copyright (c) 2007, 2011, Oracle and/or its affiliates. All rights reserved.
#

#
# Definitions common to libraries.

# include global definitions; SRC should be defined in the shell.
include $(SRC)/Makefile.master

SRCDIR =        .

X_CFLAGS        = $(OPENWINHOME)/include
MOTIF_CFLAGS    = $(MOTIFHOME)/include
NIHINC          = $(ROOT)/usr/include/nihcl
ADMININC        = ../../lib/libadmobjs
SNAGINC         = $(ROOT)/usr/include/admin

X_LIBPATH       = $(OPENWINHOME)/lib
MOTIF_LIBPATH   = $(MOTIFHOME)/lib
NIHLIB          = $(ROOT)/usr/lib
ADMLIB          = $(ROOT)/usr/lib
SNAGLIB         = $(ROOT)/usr/snadm/classes/lib

FILEMODE=	0755
LIBFILEMODE=	0444

# general class definitions

# file modes
TXTMODE		= 0644
INCLMODE	= 0644

ROOTADMINLIBS=	$(LIBS:objs/$(ARCH)/%=$(ROOTADMINLIB)/%)
ROOTADMINLIBS64=	$(LIBS:objs/$(ARCH)/%=$(ROOTADMINLIB64)/%)
ROOTADMINPLIB=	$(ROOTADMINLIB)/$(PLIB)
ROOTADMINPLIB64=	$(ROOTADMINLIB64)/$(PLIB)
ROOTUSRLIBS=	$(LIBS:objs/$(ARCH)/%=$(ROOTUSRLIB)/%)
ROOTUSRLIBS64=	$(LIBS:objs/$(ARCH)/%=$(ROOTUSRLIB64)/%)

ROOTUSRLINT=	$(LINTSRC:%=$(ROOTUSRLIB)/%) $(LINTLIB:%=$(ROOTUSRLIB)/%)
ROOTUSRLINT64=	$(LINTSRC:%=$(ROOTUSRLIB64)/%) $(LINTLIB:%=$(ROOTUSRLIB64)/%)

ROOTADMINLIBDYNLIB=	$(DYNLIB:pics/$(ARCH)/%=$(ROOTADMINLIB)/%)
ROOTADMINLIBDYNLIB64=	$(DYNLIB:pics/$(ARCH)/%=$(ROOTADMINLIB64)/%)
ROOTCACHEOSLIBDYNLIB=	$(COSDYNLIB:pics/$(ARCH)/%=$(ROOTCACHEOSLIBDIR)/%)
ROOTCACHEOSLIBDYNLIB64=	$(COSDYNLIB:pics/$(ARCH)/%=$(ROOTCACHEOSLIBDIR64)/%)
ROOTUSRLIBDYNLIB=	$(DYNLIB:pics/$(ARCH)/%=$(ROOTUSRLIB)/%)
ROOTUSRLIBDYNLIB64=	$(DYNLIB:pics/$(ARCH)/%=$(ROOTUSRLIB64)/%)

ROOTADMINLIBDYNLIBLINK=		$(ROOTADMINLIBDYNLIB:%$(VERS)=%)
ROOTADMINLIBDYNLIBLINK64=		$(ROOTADMINLIBDYNLIB64:%$(VERS)=%)
ROOTCACHEOSLIBDYNLIBLINK=	$(ROOTCACHEOSLIBDYNLIB:%$(VERS)=%)
ROOTCACHEOSLIBDYNLIBLINK64=	$(ROOTCACHEOSLIBDYNLIB64:%$(VERS)=%)
ROOTUSRLIBDYNLIBLINK=		$(ROOTUSRLIBDYNLIB:%$(VERS)=%)
ROOTUSRLIBDYNLIBLINK64=		$(ROOTUSRLIBDYNLIB64:%$(VERS)=%)

ROOTPYTHONVENDORLIBS=	$(CPYTHONLIBS:%=$(ROOTPYTHONVENDOR)/%)
ROOTPYTHONVENDORINSTALLLIBS=	$(CPYTHONLIBS:%=$(ROOTPYTHONVENDORINSTALL)/%)
ROOTPYTHONVENDORINSTALLLIBS64=	$(CPYTHONLIBS:%=$(ROOTPYTHONVENDORINSTALL64)/%)
ROOTPYTHONVENDORINSTALLMODS=	$(PYMODS:%=$(ROOTPYTHONVENDORINSTALL)/%)
ROOTPYTHONVENDORINSTALLCMODS=	$(PYCMODS:%=$(ROOTPYTHONVENDORINSTALL)/%)

ROOTPYTHONVENDORSOLINSTALLMODS=	$(PYMODS:%=$(ROOTPYTHONVENDORSOLINSTALL)/%)
ROOTPYTHONVENDORSOLINSTALLCMODS=	$(PYCMODS:%=$(ROOTPYTHONVENDORSOLINSTALL)/%)
ROOTPYTHONVENDORSOLINSTALLLIBS=	$(CPYTHONLIBS:%=$(ROOTPYTHONVENDORSOLINSTALL)/%)
ROOTPYTHONVENDORSOLINSTALLLIBS64=	$(CPYTHONLIBS:%=$(ROOTPYTHONVENDORSOLINSTALL64)/%)

ROOTPYTHONVENDORSOLINSTALLTARGETMODS=	$(PYMODS:%=$(ROOTPYTHONVENDORSOLINSTALLTARGET)/%)
ROOTPYTHONVENDORSOLINSTALLTARGETCMODS=	$(PYCMODS:%=$(ROOTPYTHONVENDORSOLINSTALLTARGET)/%)
ROOTPYTHONVENDORSOLINSTALLTARGETLIBS=	$(CPYTHONLIBS:%=$(ROOTPYTHONVENDORSOLINSTALLTARGET)/%)
ROOTPYTHONVENDORSOLINSTALLTARGETLIBS64=	$(CPYTHONLIBS:%=$(ROOTPYTHONVENDORSOLINSTALLTARGET64)/%)

ROOTPYTHONVENDORBOOTMGMTTARGETMODS=	$(PYMODS:%=$(ROOTPYTHONVENDORBOOTMGMTTARGET)/%)
ROOTPYTHONVENDORBOOTMGMTTARGETCMODS=	$(PYCMODS:%=$(ROOTPYTHONVENDORBOOTMGMTTARGET)/%)
ROOTPYTHONVENDORBOOTMGMTTARGETLIBS=	$(CPYTHONLIBS:%=$(ROOTPYTHONVENDORMGMTTARGET)/%)
ROOTPYTHONVENDORBOOTMGMTTARGETLIBS64=	$(CPYTHONLIBS:%=$(ROOTPYTHONVENDORMGMTTARGET64)/%)

DYNLIBLINK =	$(DYNLIB:%$(VERS)=%)
COSDYNLIBLINK =	$(COSDYNLIB:%$(VERS)=%)

$(ROOTUSRINCLEXP):= FILEMODE = $(INCLMODE)

$(ROOTADMINLIBS) $(ROOTADMINLIBS64):=	FILEMODE = 644
$(ROOTADMINLIBS) $(ROOTADMINLIBS64):=	OWNER = root
$(ROOTADMINLIBS) $(ROOTADMINLIBS64):=	GROUP = sys

$(ROOTADMINLIBDYNLIB) $(ROOTADMINLIBDYNLIB64):=	FILEMODE = 644
$(ROOTADMINLIBDYNLIB) $(ROOTADMINLIBDYNLIB64):=	OWNER = root
$(ROOTADMINLIBDYNLIB) $(ROOTADMINLIBDYNLIB64):=	GROUP = sys

$(ROOTCACHEOSLIBDYNLIB) $(ROOTCACHEOSLIBDYNLIB64):=FILEMODE = 644
$(ROOTCACHEOSLIBDYNLIB) $(ROOTCACHEOSLIBDYNLIB64):=OWNER = root
$(ROOTCACHEOSLIBDYNLIB) $(ROOTCACHEOSLIBDYNLIB64):=GROUP = sys

$(ROOTUSRLIBS) $(ROOTUSRLIBS64) $(ROOTUSRLINT) $(ROOTUSRLINT64):=	FILEMODE = 644
$(ROOTUSRLIBS) $(ROOTUSRLIBS64) $(ROOTUSRLINT) $(ROOTUSRLINT64):=	OWNER = root
$(ROOTUSRLIBS) $(ROOTUSRLIBS64) $(ROOTUSRLINT) $(ROOTUSRLINT64):=	GROUP = sys

$(ROOTUSRLIBDYNLIB) $(ROOTUSRLIBDYNLIB64):=	FILEMODE = 644
$(ROOTUSRLIBDYNLIB) $(ROOTUSRLIBDYNLIB64):=	OWNER = root
$(ROOTUSRLIBDYNLIB) $(ROOTUSRLIBDYNLIB64):=	GROUP = sys

$(ROOTADMINLIBDIR):=	DIRMODE = 0755
$(ROOTADMINLIBDIR64):=	DIRMODE = 0755
$(ROOTCACHEOSLIBDIR):=	DIRMODE = 0755
$(ROOTCACHEOSLIBDIR64):=	DIRMODE = 0755

$(ROOTPYTHONVENDORINSTALLMODS):=	FILEMODE = 444
$(ROOTPYTHONVENDORINSTALLMODS):=	OWNER = root
$(ROOTPYTHONVENDORINSTALLMODS):=	GROUP = bin

$(ROOTPYTHONVENDORSOLINSTALLMODS):=	FILEMODE = 444
$(ROOTPYTHONVENDORSOLINSTALLMODS):=	OWNER = root
$(ROOTPYTHONVENDORSOLINSTALLMODS):=	GROUP = bin

$(ROOTPYTHONVENDORBOOTMGMTMODS):=	FILEMODE = 444
$(ROOTPYTHONVENDORBOOTMGMTMODS):=	OWNER = root
$(ROOTPYTHONVENDORBOOTMGMTMODS):=	GROUP = bin

LORDER=		lorder
TSORT=		tsort
AWK=		awk
LD=		ld

LIBS=		$(LIBRARY:%=objs/${ARCH}/%)
PLIB=		libp/$(LIBRARY)
DYNLIB=		$(LIBRARY:%.a=pics/$(ARCH)/%.so$(VERS))
CPYTHONLIB=	$(LIBRARY:%=pics/$(ARCH)/%.so)
COSDYNLIB=	$(COSLIBRARY:%.a=pics/$(ARCH)/%.so$(VERS))
BASEDYNLIB=	$(DYNLIB:pics/$(ARCH)/%=%)
BASECOSDYNLIB=	$(COSDYNLIB:pics/$(ARCH)/%=%)
MACHPLIB=	$(MACH)/$(PLIB)
LIBNAME=	$(LIBRARY:lib%.a=%)
LINTLIB=	llib-l$(LIBNAME).ln
LINTSRC=	$(LINTLIB:%.ln=%)
LINTFLAGS=	-uaxm
ARFLAGS=	r

# TXTS allows the AT&T makefile to be bootstrapped into the NSE.
TXTS=	$(LIBRARY:.a=.mk)

OBJS=	$(OBJECTS:%=objs/${ARCH}/%)
PROFS=	$(OBJECTS:%=profs/${ARCH}/%)
PICS=	$(OBJECTS:%=pics/${ARCH}/%)

# default value for "portable" source
SRCS=	$(OBJECTS:%.o=$(SRCDIR)/%.c)

# default build of an archive,
# overridden locally when extra processing is needed
BUILD.AR=	$(AR) $(ARFLAGS) $@ $(AROBJS)

SOLIBNAME	= $(DYNLIB:pics/$(ARCH)/%=%)
COSSOLIBNAME	= $(COSDYNLIB:pics/$(ARCH)/%=%)
SOFLAGS =       -h $(SOLIBNAME) -YP,$(USRLIB)
COSSOFLAGS =    -h $(COSSOLIBNAME)

TARGETMACH=	$(MACH)

# conditional assignments
$(PROFS) :=	CFLAGS += -p
$(DYNLIB)  :=	CFLAGS += -K PIC
$(DYNLIB)  :=	CFLAGS64 += -K PIC
$(DYNLIB)  :=	CCFLAGS += -PIC
$(DYNLIB)  :=	CPPFLAGS.master +=
$(COSDYNLIB)  :=	CFLAGS += -K PIC
$(COSDYNLIB)  :=	CFLAGS64 += -K PIC
$(COSDYNLIB)  :=	CCFLAGS += -PIC
$(COSDYNLIB)  :=	CPPFLAGS.master +=
$(CPYTHONLIB)	:=	CFLAGS += -K PIC
$(CPYTHONLIB)	:=	CFLAGS64 += -K PIC
$(CPYTHONLIB)	:=	CCFLAGS += -PIC
$(CPYTHONLIB)	:=	CPPFLAGS.master +=
$(LINTLIB):=	LOG = -DLOGGING
objs/$(ARCH)/$(LIBRARY):=	AROBJS = $(OBJS)
objs/$(ARCH)/$(PLIB):=	AROBJS = $(PROFS)
$(LIBRARY):=	DIR = objs
$(PLIB):=	DIR = profs
$(DYNLIB):=	DIR = pics
$(COSDYNLIB):=	DIR = pics

$(ROOTADMINLIBS) := PNAME = objs
$(ROOTADMINLIBS64) := PNAME = objs
$(ROOTUSRLIBS) := PNAME = objs
$(ROOTUSRLIBS64) := PNAME = objs
$(ROOTADMINLIBDYNLIB) := PNAME = pics 
$(ROOTADMINLIBDYNLIB64) := PNAME = pics 
$(ROOTCACHEOSLIBDYNLIB) := PNAME = pics 
$(ROOTCACHEOSLIBDYNLIB64) := PNAME = pics 
$(ROOTUSRLIBDYNLIB) := PNAME = pics 
$(ROOTUSRLIBDYNLIB64) := PNAME = pics 
$(ROOTPYTHONVENDORLIBS) := PNAME = pics
$(ROOTPYTHONVENDORLIBS64) := PNAME = pics
$(ROOTPYTHONVENDORINSTALLLIBS) := PNAME = pics
$(ROOTPYTHONVENDORINSTALLLIBS64) := PNAME = pics
$(ROOTPYTHONVENDORSOLINSTALLLIBS) := PNAME = pics
$(ROOTPYTHONVENDORSOLINSTALLLIBS64) := PNAME = pics
$(ROOTPYTHONVENDORSOLINSTALLTARGETLIBS) := PNAME = pics
$(ROOTPYTHONVENDORSOLINSTALLTARGETLIBS64) := PNAME = pics
$(ROOTPYTHONVENDORBOOTMGMTTARGETLIBS) := PNAME = pics
$(ROOTPYTHONVENDORBOOTMGMTTARGETLIBS64) := PNAME = pics

# build rule for "portable" source
objs/${ARCH}/%.o profs/${ARCH}/%.o pics/${ARCH}/%.o: %.c
	$(PURIFY) $(COMPILE.c) -o $@ $<
	$(POST_PROCESS_O)

.PRECIOUS: $(LIBS) $(PLIB)
